<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Cuestionario de Salud — Gastos Médicos Mayores | Christian GarBa</title>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet" />
  <style>
    :root{
      --brand:#0B5ED7;
      --brand-soft:#1d4ed8;
      --danger:#f97373;
      --ink:#e5e7eb;
      --muted:#9ca3af;
      --bg:#020617;
      --panel:#020617;
      --panel-alt:#030712;
      --line:rgba(148,163,184,.40);
    }
    *{box-sizing:border-box;}
    html,body{height:100%;margin:0;}
    body{
      font-family:'Inter',system-ui,-apple-system,'Segoe UI',Roboto,Arial,sans-serif;
      background:radial-gradient(circle at top,#0b1120,#020617 55%);
      color:var(--ink);
      -webkit-font-smoothing:antialiased;
    }
    a{color:inherit;text-decoration:none;}

    .shell{
      max-width:1080px;
      margin:0 auto;
      padding:20px 16px 40px;
    }

    /* Header */
    .header{
      display:flex;
      align-items:center;
      gap:16px;
      background:rgba(15,23,42,.96);
      border:1px solid rgba(148,163,184,.45);
      border-radius:18px;
      padding:14px 18px;
      box-shadow:0 18px 45px rgba(15,23,42,.55);
      margin-bottom:18px;
    }
    .brand img{
      height:56px;
      width:auto;
      display:block;
    }
    .title-wrap{
      flex:1;
    }
    .title{
      font-size:20px;
      font-weight:700;
      letter-spacing:.02em;
    }
    .subtitle{
      font-size:13px;
      color:var(--muted);
      margin-top:2px;
    }
    .tag{
      font-size:11px;
      text-transform:uppercase;
      letter-spacing:.14em;
      color:#cbd5f5;
      border:1px solid rgba(148,163,184,.6);
      padding:4px 9px;
      border-radius:999px;
      white-space:nowrap;
    }

    /* Banner */
    .banner{
      margin:18px 0;
      border-radius:16px;
      border:1px solid rgba(248,250,252,.10);
      background:linear-gradient(135deg,#0f172a,#020617);
      padding:14px 16px 12px;
      font-size:13px;
      line-height:1.5;
    }
    .banner strong{color:#fbbf24;}
    .banner span{
      display:block;
      color:var(--muted);
      font-size:12px;
      margin-top:4px;
    }

    /* Progress */
    .progress{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
      margin-bottom:14px;
    }
    .progress-label{
      font-size:13px;
      color:var(--muted);
    }
    .progress-label strong{
      color:var(--ink);
    }
    .progress-bar{
      flex:1;
      height:6px;
      border-radius:999px;
      background:rgba(30,64,175,.45);
      overflow:hidden;
    }
    .progress-fill{
      height:100%;
      width:25%;
      background:linear-gradient(90deg,#38bdf8,#22c55e);
      transition:width .25s ease;
    }

    /* Steps / cards */
    .card{
      background:rgba(15,23,42,.96);
      border-radius:18px;
      border:1px solid rgba(148,163,184,.35);
      padding:18px 18px 16px;
      margin-bottom:14px;
    }
    .card h2{
      margin:0 0 4px;
      font-size:17px;
      font-weight:700;
    }
    .card .help{
      margin:0 0 14px;
      font-size:12px;
      color:var(--muted);
    }

    .step{display:none;}
    .step.active{display:block;}

    .grid{
      display:grid;
      grid-template-columns:repeat(auto-fit,minmax(230px,1fr));
      gap:12px 16px;
    }
    .field{
      display:flex;
      flex-direction:column;
      gap:5px;
    }
    label{
      font-size:12px;
      font-weight:500;
      color:#e5e7eb;
    }
    label span.req{
      color:#f97373;
    }
    input,select,textarea{
      border-radius:10px;
      border:1px solid rgba(148,163,184,.45);
      background:rgba(15,23,42,.9);
      color:var(--ink);
      padding:9px 10px;
      font-size:14px;
      transition:border .15s,box-shadow .15s,background .15s;
    }
    input::placeholder,textarea::placeholder{
      color:rgba(148,163,184,.75);
    }
    textarea{min-height:68px;resize:vertical;}

    input:focus,select:focus,textarea:focus{
      outline:none;
      border-color:var(--brand);
      box-shadow:0 0 0 1px rgba(37,99,235,.7);
      background:#020617;
    }

    .field-note{
      font-size:11px;
      color:var(--muted);
    }

    .inline-group{
      display:flex;
      gap:10px;
      flex-wrap:wrap;
      font-size:13px;
      color:var(--muted);
    }
    .inline-group label{
      font-size:13px;
      font-weight:400;
      display:flex;
      align-items:center;
      gap:5px;
    }

    /* Dependientes */
    .dependientes-header{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
      margin-bottom:8px;
      font-size:13px;
    }
    .pill{
      font-size:11px;
      border-radius:999px;
      border:1px solid rgba(148,163,184,.4);
      padding:3px 8px;
      color:var(--muted);
    }
    .dependiente-card{
      border-radius:14px;
      border:1px solid rgba(148,163,184,.45);
      padding:10px 12px 10px;
      background:rgba(15,23,42,.7);
      margin-bottom:8px;
    }
    .dep-header{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
      cursor:pointer;
    }
    .dep-title{
      font-size:13px;
      font-weight:600;
    }
    .dep-sub{
      font-size:11px;
      color:var(--muted);
    }
    .dep-toggle{
      font-size:11px;
      color:var(--muted);
    }
    .dep-body{margin-top:8px;display:none;}
    .dep-body.open{display:block;}

    /* Errors */
    .error-border{
      border-color:var(--danger)!important;
      box-shadow:0 0 0 1px rgba(248,113,113,.65);
    }
    .error-text{
      font-size:11px;
      color:var(--danger);
    }
    #formErrors{
      display:none;
      margin-bottom:12px;
      border-radius:12px;
      border:1px solid rgba(248,113,113,.6);
      background:rgba(127,29,29,.65);
      padding:9px 11px;
      font-size:12px;
    }
    #formErrors strong{display:block;margin-bottom:3px;}
    #formErrors ul{
      margin:4px 0 0;
      padding-left:18px;
    }

    /* Footer actions */
    .actions{
      display:flex;
      justify-content:space-between;
      align-items:center;
      gap:12px;
      margin-top:14px;
    }
    .actions-left{
      display:flex;
      gap:8px;
      flex-wrap:wrap;
      font-size:11px;
      color:var(--muted);
    }
    .btn{
      border-radius:999px;
      border:1px solid rgba(148,163,184,.6);
      background:rgba(15,23,42,.9);
      color:var(--ink);
      padding:9px 14px;
      font-size:13px;
      font-weight:600;
      cursor:pointer;
      display:inline-flex;
      align-items:center;
      gap:6px;
      transition:background .18s,transform .12s,box-shadow .18s,border .18s;
    }
    .btn-primary{
      background:linear-gradient(135deg,#2563eb,#22c55e);
      border-color:#22c55e;
      color:#f9fafb;
      box-shadow:0 12px 30px rgba(34,197,94,.35);
    }
    .btn-ghost{
      background:transparent;
    }
    .btn-secondary{
      background:#020617;
    }
    .btn:hover{
      transform:translateY(-1px);
      box-shadow:0 10px 24px rgba(15,23,42,.9);
    }
    .btn:disabled{
      opacity:.5;
      cursor:not-allowed;
      box-shadow:none;
      transform:none;
    }

    /* Print */
    @media print{
      body{
        background:#fff;
        color:#000;
      }
      .shell{
        max-width:100%;
        padding:0 18px 18px;
      }
      .header{
        box-shadow:none;
        border-radius:0;
        border:none;
        padding:10px 0 4px;
      }
      .banner,.progress,.actions,.btn,
      #formErrors{
        display:none!important;
      }
      .card{
        background:#fff;
        border:1px solid #e5e7eb;
        box-shadow:none;
        border-radius:0;
        padding:10px 8px;
        margin-bottom:10px;
      }
      input,select,textarea{
        border:none;
        border-bottom:1px solid #cbd5e1;
        border-radius:0;
        padding:4px 2px;
      }
      .dep-body{display:block!important;}
    }

    @media (max-width:640px){
      .header{
        flex-direction:row;
        align-items:flex-start;
      }
      .brand img{height:48px;}
      .actions{
        flex-direction:column-reverse;
        align-items:stretch;
      }
      .actions-left{
        justify-content:flex-start;
      }
    }
  </style>
</head>
<body>
  <div class="shell">
    <!-- HEADER -->
    <header class="header">
      <div class="brand">
        <!-- Asegúrate de subir logo-garba.png al repo -->
        <img src="logo-garba.png" alt="Christian GarBa — Seguros con Estrategia">
      </div>
      <div class="title-wrap">
        <div class="title">Cuestionario de Salud · Gastos Médicos Mayores</div>
        <div class="subtitle">Herramienta interna para recopilar datos y agilizar tu proceso de contratación.</div>
      </div>
      <div class="tag">Uso confidencial</div>
    </header>

    <!-- BANNER -->
    <section class="banner">
      <strong>Importante:</strong> Esta información se usa únicamente para analizar opciones de seguro de Gastos Médicos Mayores.
      <span>Responde con calma y con la mayor exactitud posible. Nada se envía a ninguna aseguradora hasta que lo revisemos juntos.</span>
    </section>

    <!-- PROGRESS -->
    <section class="progress">
      <div class="progress-label">
        Paso <strong id="stepLabel">1</strong> de <strong>4</strong>
      </div>
      <div class="progress-bar">
        <div class="progress-fill" id="progressFill"></div>
      </div>
    </section>

    <!-- ERROR SUMMARY -->
    <div id="formErrors">
      <strong>Revisa estos puntos antes de continuar:</strong>
      <ul id="formErrorsList"></ul>
    </div>

    <!-- PASO 1: TITULAR -->
    <section class="card step active" data-step="1">
      <h2>Paso 1 · Datos del titular</h2>
      <p class="help">Titular = persona a nombre de la póliza. Debe ser mayor de 18 años (aunque aseguremos también a su familia).</p>

      <div class="grid">
        <div class="field">
          <label for="titNombre">Nombre completo del titular <span class="req">*</span></label>
          <input id="titNombre" type="text" placeholder="Ej. Ricardo Hernández López" />
          <div class="error-text" data-error-for="titNombre"></div>
        </div>

        <div class="field">
          <label for="titRFC">RFC (opcional, ayuda a adelantar trámites)</label>
          <input id="titRFC" type="text" placeholder="Ej. HELR900101ABC" maxlength="13" />
          <div class="field-note">Si lo ingresas, intentaré inferir automáticamente tu fecha de nacimiento.</div>
          <div class="error-text" data-error-for="titRFC"></div>
        </div>

        <div class="field">
          <label for="titNac">Fecha de nacimiento <span class="req">*</span></label>
          <input id="titNac" type="date" />
          <div class="error-text" data-error-for="titNac"></div>
        </div>

        <div class="field">
          <label for="titEdad">Edad (años)</label>
          <input id="titEdad" type="number" min="0" inputmode="numeric" />
          <div class="field-note">Se calcula automáticamente al poner tu fecha de nacimiento.</div>
          <div class="error-text" data-error-for="titEdad"></div>
        </div>

        <div class="field">
          <label for="titSexo">Sexo biológico <span class="req">*</span></label>
          <select id="titSexo">
            <option value="">Selecciona una opción</option>
            <option value="H">Hombre</option>
            <option value="M">Mujer</option>
          </select>
          <div class="error-text" data-error-for="titSexo"></div>
        </div>

        <div class="field">
          <label for="titEstadoCivil">Estado civil</label>
          <select id="titEstadoCivil">
            <option value="">Selecciona</option>
            <option value="soltero">Soltero(a)</option>
            <option value="casado">Casado(a)</option>
            <option value="union">Unión libre</option>
            <option value="divorciado">Divorciado(a)</option>
            <option value="viudo">Viudo(a)</option>
          </select>
        </div>

        <div class="field">
          <label for="titCiudad">Ciudad y estado <span class="req">*</span></label>
          <input id="titCiudad" type="text" placeholder="Ej. Hermosillo, Sonora" />
          <div class="error-text" data-error-for="titCiudad"></div>
        </div>

        <div class="field">
          <label for="titTelefono">Teléfono móvil <span class="req">*</span></label>
          <input id="titTelefono" type="tel" placeholder="10 dígitos" inputmode="numeric" maxlength="10" />
          <div class="error-text" data-error-for="titTelefono"></div>
        </div>

        <div class="field">
          <label for="titEmail">Correo electrónico <span class="req">*</span></label>
          <input id="titEmail" type="email" placeholder="nombre@correo.com" />
          <div class="error-text" data-error-for="titEmail"></div>
        </div>

        <div class="field">
          <label for="titOcupacion">Ocupación</label>
          <input id="titOcupacion" type="text" placeholder="Ej. Director de empresa, contador independiente, etc." />
        </div>

        <div class="field">
          <label for="titPeso">Peso (kg) <span class="req">*</span></label>
          <input id="titPeso" type="number" step="0.1" min="0" />
          <div class="error-text" data-error-for="titPeso"></div>
        </div>

        <div class="field">
          <label for="titEstatura">Estatura (m) <span class="req">*</span></label>
          <input id="titEstatura" type="number" step="0.01" min="0" placeholder="Ej. 1.72" />
          <div class="error-text" data-error-for="titEstatura"></div>
        </div>

        <div class="field">
          <label>¿Fumas actualmente? <span class="req">*</span></label>
          <div class="inline-group">
            <label><input type="radio" name="titFuma" value="no" /> No</label>
            <label><input type="radio" name="titFuma" value="si" /> Sí</label>
            <label><input type="radio" name="titFuma" value="ex" /> Dejé de fumar</label>
          </div>
          <div class="error-text" data-error-for="titFuma"></div>
        </div>

        <div class="field" id="boxFumaActual" style="display:none;">
          <label for="titCigsDia">Si fumas: ¿cuántos cigarros al día y desde cuándo?</label>
          <textarea id="titCigsDia" placeholder="Ej. 5–8 cigarros al día desde 2015."></textarea>
        </div>

        <div class="field" id="boxExFumador" style="display:none;">
          <label for="titExFuma">Si dejaste de fumar: ¿cuándo dejaste y cuánto fumabas?</label>
          <textarea id="titExFuma" placeholder="Ej. Dejé de fumar en 2022, antes fumaba 10 al día por 8 años."></textarea>
        </div>
      </div>
    </section>

    <!-- PASO 2: QUIÉNES ASEGURAR -->
    <section class="card step" data-step="2">
      <h2>Paso 2 · ¿A quiénes deseas asegurar?</h2>
      <p class="help">Puedes asegurar solo al titular o también a su familia directa (cónyuge e hijos).</p>

      <div class="field">
        <label>Personas a asegurar <span class="req">*</span></label>
        <div class="inline-group">
          <label><input type="radio" name="grupoAsegurar" value="solo" checked /> Solo yo</label>
          <label><input type="radio" name="grupoAsegurar" value="familia" /> Yo y mi familia</label>
        </div>
      </div>

      <div class="dependientes-header">
        <div class="pill">Dependientes (máx. 5)</div>
        <button class="btn btn-secondary" type="button" id="btnAddDep">+ Agregar integrante</button>
      </div>
      <p class="help" style="margin-top:-4px;">Solo llena esta parte si deseas incluir a tu cónyuge e hijos. No es necesario duplicar tus propios datos aquí.</p>

      <div id="dependientesContainer"></div>
    </section>

    <!-- PASO 3: SALUD -->
    <section class="card step" data-step="3">
      <h2>Paso 3 · Salud y antecedentes médicos</h2>
      <p class="help">No necesitas usar términos médicos perfectos. Explica con tus palabras lo esencial (diagnóstico, año, tratamiento, si estás dado de alta, etc.).</p>

      <div class="grid">
        <div class="field">
          <label>En los últimos 5 años, ¿has tenido o te han diagnosticado alguna de las siguientes condiciones?</label>
          <div class="field-note">Marca las que apliquen y describe brevemente.</div>
          <div class="inline-group" style="margin-top:4px;">
            <label><input type="checkbox" class="chk-cond" value="diabetes" /> Diabetes</label>
            <label><input type="checkbox" class="chk-cond" value="hipertension" /> Hipertensión</label>
            <label><input type="checkbox" class="chk-cond" value="cardio" /> Problemas del corazón</label>
            <label><input type="checkbox" class="chk-cond" value="cancer" /> Cáncer / tumores</label>
            <label><input type="checkbox" class="chk-cond" value="resp" /> Asma / problemas respiratorios</label>
            <label><input type="checkbox" class="chk-cond" value="columna" /> Columna / articulaciones</label>
            <label><input type="checkbox" class="chk-cond" value="riñon" /> Riñón / hígado</label>
            <label><input type="checkbox" class="chk-cond" value="mental" /> Trastornos emocionales / psiquiátricos</label>
          </div>
        </div>

        <div class="field">
          <label for="condDetalles">Si marcaste alguna, describe aquí los detalles</label>
          <textarea id="condDetalles" placeholder="Ej. Hipertensión desde 2020, controlada con medicamento. Sin hospitalizaciones recientes."></textarea>
        </div>

        <div class="field">
          <label for="cirugias">Cirugías u hospitalizaciones importantes</label>
          <textarea id="cirugias" placeholder="Ej. Cirugía de rodilla en 2018, recuperación completa."></textarea>
        </div>

        <div class="field">
          <label>Alergias</label>
          <div class="inline-group">
            <label><input type="radio" name="alergiasTipo" value="ninguna" checked /> Ninguna conocida</label>
            <label><input type="radio" name="alergiasTipo" value="si" /> Sí tengo alergias</label>
          </div>
        </div>

        <div class="field" id="boxAlergias" style="display:none;">
          <label for="alergiasDetalle">Describe tus alergias</label>
          <textarea id="alergiasDetalle" placeholder="Ej. Alergia a penicilina y mariscos."></textarea>
        </div>

        <div class="field">
          <label>Medicamentos que tomas actualmente</label>
          <div class="inline-group">
            <label><input type="radio" name="medsTipo" value="ninguno" checked /> Ninguno de uso regular</label>
            <label><input type="radio" name="medsTipo" value="si" /> Sí tomo medicamentos</label>
          </div>
        </div>

        <div class="field" id="boxMeds" style="display:none;">
          <label for="medsDetalle">Medicamentos actuales</label>
          <textarea id="medsDetalle" placeholder="Ej. Losartán 50 mg cada 24 h, Metformina 850 mg 2 veces al día."></textarea>
        </div>

        <div class="field">
          <label for="doctorCabecera">¿Tienes médico de cabecera?</label>
          <input id="doctorCabecera" type="text" placeholder="Nombre y especialidad (opcional)" />
        </div>

        <div class="field" style="grid-column:1/-1;">
          <label for="historiaLibre">Espacio libre para contar tu historia de salud (opcional)</label>
          <textarea id="historiaLibre" placeholder="Aquí puedes explicar algo que consideres importante que yo sepa antes de cotizar tu seguro."></textarea>
        </div>
      </div>
    </section>

    <!-- PASO 4: CONFIRMACIÓN -->
    <section class="card step" data-step="4">
      <h2>Paso 4 · Revisión y envío</h2>
      <p class="help">
        Antes de enviarme tu información, lee esta breve declaración:
      </p>

      <p style="font-size:13px;color:var(--muted);margin-bottom:10px;">
        Declaro que los datos proporcionados en este cuestionario son verdaderos y completos a mi leal saber y entender.
        Entiendo que cualquier omisión o dato incorrecto puede afectar la contratación o validez futura del seguro.
        Esta información se utilizará únicamente con fines de asesoría y cotización.
      </p>

      <div class="field">
        <label><input type="checkbox" id="chkAcepto" /> Confirmo que la información que proporcioné es verdadera y completa.</label>
        <div class="error-text" data-error-for="chkAcepto"></div>
      </div>

      <div class="field" style="margin-top:10px;">
        <label for="comentarioFinal">Comentario final (opcional)</label>
        <textarea id="comentarioFinal" placeholder="Ej. Me interesa comparar varias aseguradoras, priorizando red hospitalaria y deducible medio."></textarea>
      </div>

      <p class="field-note" style="margin-top:8px;">
        Al hacer clic en “Enviar a mi asesor” se abrirá WhatsApp con un resumen estructurado de tu información para que yo pueda avanzar con tu cotización.
        También puedes elegir “Descargar en PDF” para guardar una copia para ti.
      </p>
    </section>

    <!-- ACCIONES GLOBALES -->
    <section class="actions">
      <div class="actions-left">
        <span>Christian GarBa · Seguros con Estrategia</span>
      </div>
      <div class="actions-right" style="display:flex;gap:8px;flex-wrap:wrap;">
        <button class="btn btn-ghost" type="button" id="btnPrev">← Anterior</button>
        <button class="btn btn-secondary" type="button" id="btnNext">Siguiente →</button>
        <button class="btn btn-primary" type="button" id="btnWhatsApp" style="display:none;">Enviar a mi asesor</button>
        <button class="btn btn-secondary" type="button" id="btnPDF" style="display:none;">Descargar en PDF</button>
      </div>
    </section>
  </div>

  <script>
    // Helpers
    const $ = id => document.getElementById(id);
    const byName = name => document.querySelectorAll(`input[name="${name}"]`);
    const money = v => new Intl.NumberFormat('es-MX',{style:'currency',currency:'MXN'}).format(Number(v)||0);

    const steps = Array.from(document.querySelectorAll('.step'));
    const totalSteps = steps.length;
    let currentStep = 1;

    function showStep(step){
      currentStep = step;
      steps.forEach(sec=>{
        const s = Number(sec.dataset.step);
        sec.classList.toggle('active', s===step);
      });
      $('stepLabel').textContent = String(step);
      const fill = $('progressFill');
      fill.style.width = `${(step/totalSteps)*100}%`;

      $('btnPrev').disabled = step===1;
      $('btnNext').style.display = step===totalSteps ? 'none':'inline-flex';
      $('btnWhatsApp').style.display = step===totalSteps ? 'inline-flex':'none';
      $('btnPDF').style.display = step===totalSteps ? 'inline-flex':'none';

      // Limpia errores de bloque al cambiar de paso
      clearErrors();
    }

    // RFC -> fecha de nacimiento
    function parseRFCDate(rfc){
      const clean = (rfc||'').trim().toUpperCase();
      const m = clean.match(/^[A-ZÑ&]{3,4}(\d{2})(\d{2})(\d{2})/);
      if(!m) return null;
      const [yy,mm,dd] = [m[1],m[2],m[3]].map(Number);
      if(mm<1||mm>12||dd<1||dd>31) return null;
      const now = new Date();
      const currentYear = now.getFullYear()%100;
      const century = yy>currentYear ? 1900 : 2000;
      return new Date(century+yy,mm-1,dd);
    }

    function calcAge(dateStr){
      if(!dateStr) return '';
      const d = new Date(dateStr);
      if(Number.isNaN(d.getTime())) return '';
      const today = new Date();
      let age = today.getFullYear() - d.getFullYear();
      const m = today.getMonth() - d.getMonth();
      if(m<0 || (m===0 && today.getDate()<d.getDate())) age--;
      return age;
    }

    // VALIDACIÓN
    function clearErrors(){
      document.querySelectorAll('.error-border').forEach(el=>el.classList.remove('error-border'));
      document.querySelectorAll('.error-text').forEach(el=>el.textContent='');
      const box = $('formErrors');
      if(box){
        box.style.display='none';
        $('formErrorsList').innerHTML='';
      }
    }

    function setError(id,message){
      const input = $(id);
      if(input){
        input.classList.add('error-border');
      }
      const err = document.querySelector(`.error-text[data-error-for="${id}"]`);
      if(err){err.textContent = message;}
      return {id,message};
    }

    function validateStep(step){
      clearErrors();
      const issues = [];

      if(step===1){
        if(!$('titNombre').value.trim()) issues.push(setError('titNombre','Escribe el nombre completo del titular.'));
        const fNac = $('titNac').value;
        if(!fNac) issues.push(setError('titNac','Indica tu fecha de nacimiento.'));
        const edad = parseInt(calcAge(fNac)||$('titEdad').value,10);
        if(!edad || edad<18){
          issues.push(setError('titEdad','El titular debe ser mayor de 18 años.'));
        }
        if(!$('titCiudad').value.trim()) issues.push(setError('titCiudad','Indica ciudad y estado.'));
        const tel = $('titTelefono').value.trim();
        if(!/^\d{10}$/.test(tel)) issues.push(setError('titTelefono','Ingresa un teléfono de 10 dígitos.'));
        const mail = $('titEmail').value.trim();
        if(!/^[^@\s]+@[^@\s]+\.[^@\s]+$/.test(mail)) issues.push(setError('titEmail','Ingresa un correo válido.'));
        if(!$('titSexo').value) issues.push(setError('titSexo','Selecciona una opción.'));
        if(!$('titPeso').value) issues.push(setError('titPeso','Indica tu peso aproximado.'));
        if(!$('titEstatura').value) issues.push(setError('titEstatura','Indica tu estatura.'));

        const fumaSel = Array.from(byName('titFuma')).find(r=>r.checked);
        if(!fumaSel) issues.push(setError('titFuma','Indica si fumas actualmente o si dejaste de fumar.'));
      }

      if(step===2){
        // si selecciona familia, validar que haya al menos 1 dependiente con nombre y parentesco
        const grupo = Array.from(byName('grupoAsegurar')).find(r=>r.checked)?.value || 'solo';
        if(grupo==='familia'){
          const deps = document.querySelectorAll('.dependiente-card');
          if(!deps.length){
            issues.push({id:'',message:'Agrega al menos un integrante dependiente si seleccionaste "Yo y mi familia".'});
          }else{
            let idx=1;
            deps.forEach(card=>{
              const nombre = card.querySelector('.dep-nombre');
              const parent = card.querySelector('.dep-parentesco');
              if(nombre && !nombre.value.trim()){
                nombre.classList.add('error-border');
                issues.push({id:`dep${idx}nombre`,message:`Falta el nombre del dependiente ${idx}.`});
              }
              if(parent && !parent.value){
                parent.classList.add('error-border');
                issues.push({id:`dep${idx}paren`,message:`Selecciona el parentesco del dependiente ${idx}.`});
              }
              idx++;
            });
          }
        }
      }

      if(step===3){
        const condMarcadas = document.querySelectorAll('.chk-cond:checked').length>0;
        const condTexto = $('condDetalles').value.trim();
        if(condMarcadas && !condTexto){
          issues.push(setError('condDetalles','Describe brevemente las condiciones marcadas.'));
        }
        const alergSel = Array.from(byName('alergiasTipo')).find(r=>r.checked)?.value;
        if(alergSel==='si' && !$('alergiasDetalle').value.trim()){
          issues.push(setError('alergiasDetalle','Describe tus alergias principales.'));
        }
        const medsSel = Array.from(byName('medsTipo')).find(r=>r.checked)?.value;
        if(medsSel==='si' && !$('medsDetalle').value.trim()){
          issues.push(setError('medsDetalle','Indica los medicamentos que tomas actualmente.'));
        }
      }

      if(step===4){
        if(!$('chkAcepto').checked){
          issues.push(setError('chkAcepto','Debes confirmar que la información es verdadera.'));
        }
      }

      if(issues.length){
        const list = $('formErrorsList');
        list.innerHTML='';
        issues.forEach(it=>{
          const li = document.createElement('li');
          li.textContent = it.message;
          list.appendChild(li);
        });
        $('formErrors').style.display='block';

        // scroll al primer error visual
        const firstErrId = issues[0].id;
        if(firstErrId){
          const el = document.querySelector(`[data-error-for="${firstErrId}"]`) || $(firstErrId);
          if(el){
            setTimeout(()=>{el.scrollIntoView({behavior:'smooth',block:'center'});},80);
          }
        }
        return false;
      }
      return true;
    }

    // Dependientes
    let depCount = 0;
    const maxDeps = 5;

    function addDependiente(){
      if(depCount>=maxDeps) return;
      depCount++;
      const cont = $('dependientesContainer');
      const card = document.createElement('div');
      card.className = 'dependiente-card';
      card.dataset.index = String(depCount);
      card.innerHTML = `
        <div class="dep-header">
          <div>
            <div class="dep-title">Dependiente ${depCount}</div>
            <div class="dep-sub">Haz clic para mostrar/ocultar detalles</div>
          </div>
          <div class="dep-toggle">▼</div>
        </div>
        <div class="dep-body">
          <div class="grid">
            <div class="field">
              <label>Nombre completo <span class="req">*</span></label>
              <input type="text" class="dep-nombre" placeholder="Ej. Ana Sofía Hernández" />
            </div>
            <div class="field">
              <label>Parentesco <span class="req">*</span></label>
              <select class="dep-parentesco">
                <option value="">Selecciona</option>
                <option value="conyuge">Esposo(a)</option>
                <option value="hijo">Hijo</option>
                <option value="hija">Hija</option>
                <option value="otro">Otro</option>
              </select>
            </div>
            <div class="field">
              <label>Fecha de nacimiento</label>
              <input type="date" class="dep-nac" />
            </div>
            <div class="field">
              <label>Sexo biológico</label>
              <select class="dep-sexo">
                <option value="">Selecciona</option>
                <option value="H">Hombre</option>
                <option value="M">Mujer</option>
              </select>
            </div>
            <div class="field">
              <label>Peso (kg)</label>
              <input type="number" step="0.1" class="dep-peso" />
            </div>
            <div class="field">
              <label>Estatura (m)</label>
              <input type="number" step="0.01" class="dep-estatura" />
            </div>
            <div class="field">
              <label>¿Tiene alguna condición importante que debamos saber?</label>
              <textarea class="dep-salud" placeholder="Padecimientos relevantes, cirugías, medicamentos, etc."></textarea>
            </div>
          </div>
        </div>
      `;
      cont.appendChild(card);

      const header = card.querySelector('.dep-header');
      const body = card.querySelector('.dep-body');
      header.addEventListener('click',()=>{
        body.classList.toggle('open');
        const toggle = card.querySelector('.dep-toggle');
        toggle.textContent = body.classList.contains('open') ? '▲':'▼';
      });
    }

    // WhatsApp message
    function buildWhatsAppMessage(){
      const edad = $('titEdad').value || calcAge($('titNac').value);
      const grupo = Array.from(byName('grupoAsegurar')).find(r=>r.checked)?.value || 'solo';

      const deps = [];
      document.querySelectorAll('.dependiente-card').forEach(card=>{
        const nom = card.querySelector('.dep-nombre')?.value.trim();
        const par = card.querySelector('.dep-parentesco')?.value;
        if(nom){
          deps.push(`- ${nom} (${par||'sin parentesco'})`);
        }
      });

      const condMarcadas = Array.from(document.querySelectorAll('.chk-cond:checked')).map(c=>c.nextSibling.textContent.trim());
      const alergSel = Array.from(byName('alergiasTipo')).find(r=>r.checked)?.value;
      const medsSel = Array.from(byName('medsTipo')).find(r=>r.checked)?.value;

      const partes = [];
      partes.push('Hola Christian, te envío mi cuestionario de salud para GMM:');
      partes.push('');
      partes.push('*Titular*');
      partes.push(`Nombre: ${$('titNombre').value.trim()}`);
      partes.push(`Edad: ${edad||'—'} años`);
      partes.push(`Sexo: ${$('titSexo').value||'—'}`);
      partes.push(`Ciudad: ${$('titCiudad').value.trim()}`);
      partes.push(`Teléfono: ${$('titTelefono').value.trim()}`);
      partes.push(`Ocupación: ${$('titOcupacion').value.trim()||'—'}`);
      partes.push('');
      partes.push('*Personas a asegurar*');
      partes.push(grupo==='solo' ? 'Solo el titular' : 'Titular + familia');
      if(deps.length){
        partes.push('Dependientes:');
        partes.push(...deps);
      }
      partes.push('');
      partes.push('*Salud general*');
      if(condMarcadas.length){
        partes.push('Condiciones marcadas: ' + condMarcadas.join(', '));
      }else{
        partes.push('Sin condiciones relevantes marcadas en la lista.');
      }
      if($('cirugias').value.trim()){
        partes.push('Cirugías / hospitalizaciones: ' + $('cirugias').value.trim());
      }
      if(alergSel==='si'){
        partes.push('Alergias: ' + $('alergiasDetalle').value.trim());
      }
      if(medsSel==='si'){
        partes.push('Medicamentos actuales: ' + $('medsDetalle').value.trim());
      }
      if($('historiaLibre').value.trim()){
        partes.push('');
        partes.push('Nota de salud: ' + $('historiaLibre').value.trim());
      }
      if($('comentarioFinal').value.trim()){
        partes.push('');
        partes.push('Comentario final: ' + $('comentarioFinal').value.trim());
      }

      return partes.join('\n');
    }

    // EVENTOS
    $('titRFC').addEventListener('blur',()=>{
      const rfc = $('titRFC').value;
      if(!rfc) return;
      const d = parseRFCDate(rfc);
      if(d){
        const iso = d.toISOString().slice(0,10);
        if(!$('titNac').value) $('titNac').value = iso;
        $('titEdad').value = calcAge(iso);
      }else{
        const err = document.querySelector('[data-error-for="titRFC"]');
        if(err) err.textContent = 'No pude leer la fecha de nacimiento a partir del RFC. Verifica que esté completo.';
      }
    });

    $('titNac').addEventListener('change',()=>{
      const val = $('titNac').value;
      $('titEdad').value = calcAge(val);
    });

    // Fuma logic
    byName('titFuma').forEach(r=>{
      r.addEventListener('change',()=>{
        const v = r.value;
        $('boxFumaActual').style.display = v==='si' ? 'block':'none';
        $('boxExFumador').style.display = v==='ex' ? 'block':'none';
      });
    });

    // Alergias / meds
    byName('alergiasTipo').forEach(r=>{
      r.addEventListener('change',()=>{
        $('boxAlergias').style.display = r.value==='si' ? 'block':'none';
      });
    });
    byName('medsTipo').forEach(r=>{
      r.addEventListener('change',()=>{
        $('boxMeds').style.display = r.value==='si' ? 'block':'none';
      });
    });

    // Grupo asegurar
    byName('grupoAsegurar').forEach(r=>{
      r.addEventListener('change',()=>{
        // no hacemos nada especial aún
      });
    });

    $('btnAddDep').addEventListener('click',addDependiente);

    // Navegación
    $('btnNext').addEventListener('click',()=>{
      if(!validateStep(currentStep)) return;
      if(currentStep<totalSteps) showStep(currentStep+1);
    });
    $('btnPrev').addEventListener('click',()=>{
      if(currentStep>1) showStep(currentStep-1);
    });

    // Enviar WhatsApp
    $('btnWhatsApp').addEventListener('click',()=>{
      if(!validateStep(4)) return;
      const msg = buildWhatsAppMessage();
      const url = 'https://wa.me/526624176032?text='+encodeURIComponent(msg);
      window.open(url,'_blank');
    });

    // PDF
    $('btnPDF').addEventListener('click',()=>{
      if(!validateStep(4)) return;
      window.print();
    });

    // Inline simple: al escribir elimina borde rojo
    document.querySelectorAll('input,select,textarea').forEach(el=>{
      el.addEventListener('input',()=>{
        el.classList.remove('error-border');
        const err = document.querySelector(`.error-text[data-error-for="${el.id}"]`);
        if(err) err.textContent='';
      });
    });

    // Inicio
    showStep(1);
  </script>
</body>
</html>
